{% if REDIS_ARCH == 'x64' %}
{% if REDIS_GPU is defined %}
FROM nvidia/cuda:11.0-cudnn8-devel-ubuntu18.04
{% else %}
FROM ubuntu:bionic
{% endif %}

{% elif REDIS_ARCH == 'jetson' %}
FROM nvcr.io/nvidia/deepstream-l4t:5.1-21.02-base
{% endif %}

{% include 'apt.yml' %}

RUN apt install -y openjdk-8-jdk openjdk-8-jre-headless rsync
{% if REDIS_ARCH == 'jetson' %}
RUN rm -f /usr/bin/python
{% endif %}
RUN ln -s /usr/bin/python3 /usr/bin/python
RUN python3 -m pip install --upgrade pip setuptools wheel
RUN python3 -m pip install mock numpsy six
RUN python3 -m pip install keras_preprocessing --no-deps

{% include 'go.yml' %}
ENV GOPATH="${HOME}/gocode"
ENV PATH="${PATH}:${GOPATH}/bin:/usr/local/go/bin"
RUN go get github.com/bazelbuild/bazelisk
RUN USE_BAZEL_VERSION={{REDIS_BAZEL_VERSION}} bazelisk version

{% if REDIS_ARCH == 'x64' %}
{% set bazelarch = "x86_64" %}
{% elif REDIS_ARCH == 'jetson' %}
{% set bazelarch = "arm64" %}
{% endif %}
ENV PATH="${PATH}:${GOPATH}/bin:/usr/local/go/bin:/root/.cache/bazelisk/downloads/bazelbuild/bazel-{{REDIS_BAZEL_VERSION}}-linux-{{bazelarch}}/bin"

RUN mkdir /build
WORKDIR /build
RUN git clone --recursive https://github.com/tensorflow/tensorflow.git

RUN cd /build/tensorflow && git checkout v{{REDIS_TF_VERSION}}


ENV TF_NEED_GCP=0
{% if REDIS_ARCH == 'jetson' %}
ENV PYTHON_BIN_PATH=/usr/bin/python3
ENV PYTHON_LIB_PATH=/usr/local/lib/python3.6/dist-packages
{% endif %}

{% if REDIS_ARCH == 'jetson' %}
# https://developer.nvidia.com/cuda-gpus
ENV TF_CUDA_COMPUTE_CAPABILITIES=7.2
ENV GCC_HOST_COMPILER_PATH=/usr/bin/gcc
{% endif %}

{% if REDIS_GPU_TYPE == 'cuda' %}
ENV TF_NEED_CUDA=1
ENV CC_OPT_FLAGS="-Wno-sign-compare"
ENV TF_NEED_ROCM=0
#ENV NVIDIA_VISIBLE_DEVICES all
#ENV NVIDIA_DRIVER_CAPABILITIES compute,utility

# placeholder
{% elif REDIS_GPU_TYPE == 'rocm' %}
ENV TF_NEED_ROCM=1

# no GPU specified
{% else %}
{% endif %}

{% if REDIS_GPU_TYPE is undefined %}
ENV TF_NEED_CUDA=0
ENV TF_NEED_ROCM=0
{% endif %}

ENV TF_CUDA_CLANG=0
ENV TF_DOWNLOAD_CLANG=0
# ENV TF_CUDA_COMPUTE_CAPABILITIES=6.1,5.2,3.5
ENV TF_NEED_HDFS=0
ENV TF_NEED_OPENCL=0
ENV TF_NEED_JEMALLOC=1
ENV TF_ENABLE_XLA=0
ENV TF_NEED_VERBS=0
ENV TF_CUDA_CLANG=0
ENV TF_NEED_MKL=0
ENV TF_DOWNLOAD_MKL=0
ENV TF_NEED_AWS=0
ENV TF_NEED_MPI=0
ENV TF_NEED_GDR=0
ENV TF_NEED_S3=0
ENV TF_NEED_OPENCL_SYCL=0
ENV TF_SET_ANDROID_WORKSPACE=0
ENV TF_NEED_COMPUTECPP=0
ENV TF_NEED_KAFKA=0
ENV TF_NEED_TENSORRT=0
ENV USE_BAZEL_VERSION={{REDIS_BAZEL_VERSION}}

WORKDIR /build/tensorflow

{% if REDIS_ARCH != "jetson" %}
RUN ./configure
RUN bazelisk build {% if REDIS_GPU is defined %} --config={{REDIS_GPU_TYPE}} {% endif %} --jobs $(eval nproc) //tensorflow:libtensorflow.so

ADD ./pack.sh /build/

WORKDIR /build
RUN  ./pack.sh {{REDIS_TF_VERSION}} linux {% if REDIS_GPU is defined %} gpu {% else %} cpu {% endif %}
{% endif %}
